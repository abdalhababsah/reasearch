import{c as pt,r as c,j as t,a as bt,H as wt,L as yt}from"./app-XseEcuwc.js";import{B as Te}from"./button-DI4PaxQ7.js";import{T as vt}from"./textarea-UpJGMb4k.js";import{A as jt}from"./app-layout-CZoO53OF.js";import{u as St}from"./index-CR-rnG23.js";import Nt from"./create-label-dialog-ZaYgkp6f.js";import{D as _t}from"./download-CEZ7BJdo.js";import{T as Ct}from"./trash-2-amZuM-2x.js";import{A as Lt}from"./arrow-left-CY72dKNG.js";import{S as Mt}from"./save-DfZnMHqC.js";/* empty css            */import"./x-DgzPl7e4.js";import"./input-MwdOiVtB.js";import"./index-BHKBQx4H.js";import"./index-C3Hm02L2.js";import"./index-DRE42a0L.js";import"./index-BDsVhmEQ.js";import"./index-DPjtb1Rz.js";import"./select-Bhj_cBoa.js";import"./index-BitGjllA.js";import"./app-logo-icon-3mANveO6.js";import"./index-BZB35nAZ.js";import"./index-CMWG4mbA.js";import"./app-logo-BdIHiqic.js";import"./chevron-right-BMEIDfYh.js";import"./dialog-DBndcIzu.js";import"./label-DepknyqC.js";import"./loader-circle-v5nqKdhA.js";import"./plus-CF7Brvnu.js";function rt(a="ann"){return typeof crypto<"u"&&"randomUUID"in crypto?`${a}-${crypto.randomUUID()}`:`${a}-${Date.now()}-${Math.random().toString(16).slice(2)}`}function os(a){const e=pt.c(168),{image:r,labels:w}=a,{t:n}=St(),Ue=c.useRef(null),He=c.useRef(null),y=c.useRef(null),[v,ct]=c.useState(!1);let ce;e[0]===Symbol.for("react.memo_cache_sentinel")?(ce={width:800,height:600},e[0]=ce):ce=e[0];const[j,dt]=c.useState(ce);c.useState(1);const[g,mt]=c.useState(w),[m,ht]=c.useState(w[0]||null),[Be,ft]=c.useState(!1);let de;e[1]!==r.annotations?(de=()=>(r.annotations||[]).map(At),e[1]=r.annotations,e[2]=de):de=e[2];const[o,Pe]=c.useState(de);let me,he;e[3]!==w?(me=()=>{mt(w)},he=[w],e[3]=w,e[4]=me,e[5]=he):(me=e[4],he=e[5]),c.useEffect(me,he);const[h,st]=c.useState(!1);let fe;e[6]===Symbol.for("react.memo_cache_sentinel")?(fe={x:0,y:0},e[6]=fe):fe=e[6];const[f,ut]=c.useState(fe);let ue;e[7]===Symbol.for("react.memo_cache_sentinel")?(ue={x:0,y:0},e[7]=ue):ue=e[7];const[u,lt]=c.useState(ue);c.useState(null);const[S,We]=c.useState(!1),[x,nt]=c.useState(null);let N;e[8]!==n?(N=n("images.title")||"Images",e[8]=n,e[9]=N):N=e[9];let _;e[10]!==N?(_={title:N,href:"/researcher/images"},e[10]=N,e[11]=_):_=e[11];const Oe=r.title||r.original_filename,Xe=`/researcher/images/${r.id}`;let C;e[12]!==Xe||e[13]!==Oe?(C={title:Oe,href:Xe},e[12]=Xe,e[13]=Oe,e[14]=C):C=e[14];let L;e[15]!==n?(L=n("images.annotate.title")||"Annotate",e[15]=n,e[16]=L):L=e[16];const Ye=`/researcher/images/${r.id}/annotate`;let M;e[17]!==L||e[18]!==Ye?(M={title:L,href:Ye},e[17]=L,e[18]=Ye,e[19]=M):M=e[19];let xe;e[20]!==C||e[21]!==M||e[22]!==_?(xe=[_,C,M],e[20]=C,e[21]=M,e[22]=_,e[23]=xe):xe=e[23];const Je=xe;let ge;e[24]===Symbol.for("react.memo_cache_sentinel")?(ge=()=>{if(Ue.current){const s=Ue.current.getBoundingClientRect();dt({width:s.width,height:s.height})}},e[24]=ge):ge=e[24];const qe=ge;let pe;e[25]===Symbol.for("react.memo_cache_sentinel")?(pe=s=>{const l=He.current;if(!l||!y.current)return{x:0,y:0};const i=l.getBoundingClientRect(),d=(s.clientX-i.left)/i.width*(y.current.naturalWidth||1),p=(s.clientY-i.top)/i.height*(y.current.naturalHeight||1);return{x:d,y:p}},e[25]=pe):pe=e[25];const it=pe;let be;e[26]!==o||e[27]!==u||e[28]!==f||e[29]!==v||e[30]!==h||e[31]!==g||e[32]!==x||e[33]!==m?.color?(be=()=>{const s=He.current,l=s?.getContext("2d"),i=y.current;if(!(!s||!l||!i||!v)&&(l.clearRect(0,0,s.width,s.height),l.drawImage(i,0,0,s.width,s.height),o.forEach(d=>{const p=g.find(gt=>gt.id===d.label_id),b=p?.color||"#3b82f6",Ee=s.width/(i.naturalWidth||1),ze=s.height/(i.naturalHeight||1),re=d.x*Ee,tt=d.y*ze,at=d.width*Ee,ot=d.height*ze;l.strokeStyle=b,l.lineWidth=d.clientId===x?3:2,l.strokeRect(re,tt,at,ot),l.fillStyle=b+"30",l.fillRect(re,tt,at,ot),l.fillStyle=b,l.font="bold 14px sans-serif",l.fillText(p?.name||"Unknown",re+5,tt+20)}),h)){const d=s.width/(i.naturalWidth||1),p=s.height/(i.naturalHeight||1),b=Math.min(f.x,u.x)*d,Ee=Math.min(f.y,u.y)*p,ze=Math.abs(u.x-f.x)*d,re=Math.abs(u.y-f.y)*p;l.strokeStyle=m?.color||"#3b82f6",l.lineWidth=2,l.setLineDash([5,5]),l.strokeRect(b,Ee,ze,re),l.setLineDash([])}},e[26]=o,e[27]=u,e[28]=f,e[29]=v,e[30]=h,e[31]=g,e[32]=x,e[33]=m?.color,e[34]=be):be=e[34];const Fe=be;let we;e[35]!==Fe?(we=()=>{Fe()},e[35]=Fe,e[36]=we):we=e[36];let ye;e[37]!==o||e[38]!==u||e[39]!==f||e[40]!==v||e[41]!==h||e[42]!==x?(ye=[o,h,f,u,v,x],e[37]=o,e[38]=u,e[39]=f,e[40]=v,e[41]=h,e[42]=x,e[43]=ye):ye=e[43],c.useEffect(we,ye);let ve,je;e[44]!==r.url?(ve=()=>{const s=new Image;return s.src=r.url,s.onload=()=>{y.current=s,ct(!0),qe()},window.addEventListener("resize",qe),()=>window.removeEventListener("resize",qe)},je=[r.url],e[44]=r.url,e[45]=ve,e[46]=je):(ve=e[45],je=e[46]),c.useEffect(ve,je);let Se;e[47]!==m?(Se=s=>{if(!m||!y.current)return;const l=it(s);st(!0),ut(l),lt(l)},e[47]=m,e[48]=Se):Se=e[48];const Ge=Se;let Ne;e[49]!==h?(Ne=s=>{if(!h)return;const l=it(s);lt(l)},e[49]=h,e[50]=Ne):Ne=e[50];const Ke=Ne;let _e;e[51]!==u||e[52]!==f||e[53]!==h||e[54]!==m?(_e=()=>{if(!h||!m)return;st(!1);const s=Math.min(f.x,u.x),l=Math.min(f.y,u.y),i=Math.abs(u.x-f.x),d=Math.abs(u.y-f.y);if(i>5&&d>5){const p={clientId:rt("ann"),label_id:m.id,x:s,y:l,width:i,height:d,notes:null};Pe(b=>[...b,p])}},e[51]=u,e[52]=f,e[53]=h,e[54]=m,e[55]=_e):_e=e[55];const Ce=_e;let Le;e[56]!==x?(Le=s=>{Pe(l=>l.filter(i=>i.clientId!==s)),x===s&&nt(null)},e[56]=x,e[57]=Le):Le=e[57];const Qe=Le;let Me;e[58]===Symbol.for("react.memo_cache_sentinel")?(Me=(s,l)=>{Pe(i=>i.map(d=>d.clientId===s?{...d,notes:l}:d))},e[58]=Me):Me=e[58];const xt=Me;let Ie;e[59]!==o||e[60]!==r.id?(Ie=()=>{We(!0),bt.put(`/researcher/images/${r.id}/annotations`,{annotations:o.map(kt)},{onSuccess:()=>We(!1),onError:()=>We(!1)})},e[59]=o,e[60]=r.id,e[61]=Ie):Ie=e[61];const Ve=Ie;let ke;e[62]!==r.id?(ke=()=>{window.location.href=`/researcher/images/${r.id}/export`},e[62]=r.id,e[63]=ke):ke=e[63];const Ze=ke;let I;e[64]!==n?(I=n("images.annotate.title")||"Annotate Image",e[64]=n,e[65]=I):I=e[65];let k;e[66]!==I?(k=t.jsx(wt,{title:I}),e[66]=I,e[67]=k):k=e[67];let A;e[68]!==n?(A=n("images.annotate.title")||"Annotate Image",e[68]=n,e[69]=A):A=e[69];let D;e[70]!==A?(D=t.jsx("h1",{className:"text-2xl font-semibold",children:A}),e[70]=A,e[71]=D):D=e[71];const et=r.title||r.original_filename;let R;e[72]!==et?(R=t.jsx("p",{className:"text-sm text-muted-foreground",children:et}),e[72]=et,e[73]=R):R=e[73];let $;e[74]!==D||e[75]!==R?($=t.jsxs("div",{children:[D,R]}),e[74]=D,e[75]=R,e[76]=$):$=e[76];let Ae;e[77]===Symbol.for("react.memo_cache_sentinel")?(Ae=t.jsx(Lt,{className:"h-4 w-4 mr-2"}),e[77]=Ae):Ae=e[77];let E;e[78]!==n?(E=n("actions.back")||"Back",e[78]=n,e[79]=E):E=e[79];let z;e[80]!==E?(z=t.jsx("div",{className:"flex gap-2",children:t.jsx(Te,{asChild:!0,variant:"ghost",children:t.jsxs(yt,{href:"/researcher/images",children:[Ae,E]})})}),e[80]=E,e[81]=z):z=e[81];let T;e[82]!==$||e[83]!==z?(T=t.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[$,z]}),e[82]=$,e[83]=z,e[84]=T):T=e[84];let U;e[85]!==n?(U=n("images.annotate.selectLabel")||"Select Label",e[85]=n,e[86]=U):U=e[86];let H;e[87]!==U?(H=t.jsx("h2",{className:"text-sm font-semibold",children:U}),e[87]=U,e[88]=H):H=e[88];let B;e[89]!==Be?(B=t.jsx(Nt,{open:Be,onOpenChange:ft}),e[89]=Be,e[90]=B):B=e[90];let P;e[91]!==H||e[92]!==B?(P=t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[H,B]}),e[91]=H,e[92]=B,e[93]=P):P=e[93];let W;if(e[94]!==g||e[95]!==m?.id){let s;e[97]!==m?.id?(s=l=>t.jsx("button",{type:"button",onClick:()=>ht(l),className:`rounded-full px-4 py-2 text-sm font-medium transition-all ${m?.id===l.id?"ring-2 ring-offset-2 scale-105 shadow-lg":"opacity-70 hover:opacity-100"}`,style:{backgroundColor:l.color+"20",border:`2px solid ${l.color}`,color:l.color},title:l.description||void 0,children:t.jsxs("span",{className:"inline-flex items-center gap-2",children:[t.jsx("span",{className:"h-3 w-3 rounded-full",style:{backgroundColor:l.color}}),l.name]})},l.id),e[97]=m?.id,e[98]=s):s=e[98],W=g.map(s),e[94]=g,e[95]=m?.id,e[96]=W}else W=e[96];let O;e[99]!==W?(O=t.jsx("div",{className:"flex flex-wrap gap-2",children:W}),e[99]=W,e[100]=O):O=e[100];let X;e[101]!==P||e[102]!==O?(X=t.jsxs("div",{className:"rounded-xl border bg-card p-4 shadow-sm",children:[P,O]}),e[101]=P,e[102]=O,e[103]=X):X=e[103];let De;e[104]===Symbol.for("react.memo_cache_sentinel")?(De={height:"600px"},e[104]=De):De=e[104];let Y;e[105]!==j.height||e[106]!==j.width||e[107]!==Ge||e[108]!==Ke||e[109]!==Ce?(Y=t.jsx("canvas",{ref:He,width:j.width,height:j.height,className:"w-full h-full cursor-crosshair",onMouseDown:Ge,onMouseMove:Ke,onMouseUp:Ce,onMouseLeave:Ce}),e[105]=j.height,e[106]=j.width,e[107]=Ge,e[108]=Ke,e[109]=Ce,e[110]=Y):Y=e[110];let J;e[111]!==o.length||e[112]!==h||e[113]!==n?(J=o.length===0&&!h&&t.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:t.jsxs("div",{className:"bg-white/90 px-4 py-2 rounded-lg shadow-sm text-gray-500 text-sm text-center",children:[t.jsx("div",{className:"font-medium mb-1",children:n("images.annotate.noAnnotations")||"No annotations yet"}),t.jsx("div",{className:"text-xs",children:n("images.annotate.drawHelp")||"Select a label and draw boxes on the image"})]})}),e[111]=o.length,e[112]=h,e[113]=n,e[114]=J):J=e[114];let q;e[115]!==Y||e[116]!==J?(q=t.jsxs("div",{ref:Ue,className:"relative bg-gray-100 rounded-lg overflow-hidden",style:De,children:[Y,J]}),e[115]=Y,e[116]=J,e[117]=q):q=e[117];let F;e[118]!==n?(F=n("images.annotate.instructions")||"Tip: Select a label, then click and drag to draw bounding boxes on the image",e[118]=n,e[119]=F):F=e[119];let G;e[120]!==F?(G=t.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:F}),e[120]=F,e[121]=G):G=e[121];let K;e[122]!==q||e[123]!==G?(K=t.jsxs("div",{className:"rounded-xl border bg-card p-4 shadow-sm",children:[q,G]}),e[122]=q,e[123]=G,e[124]=K):K=e[124];let Re;e[125]===Symbol.for("react.memo_cache_sentinel")?(Re=t.jsx(Mt,{className:"h-4 w-4 mr-2"}),e[125]=Re):Re=e[125];let Q;e[126]!==S||e[127]!==n?(Q=S?n("images.annotate.saving")||"Saving...":n("images.annotate.save")||"Save",e[126]=S,e[127]=n,e[128]=Q):Q=e[128];let V;e[129]!==Ve||e[130]!==S||e[131]!==Q?(V=t.jsxs(Te,{onClick:Ve,disabled:S,className:"flex-1",type:"button",children:[Re,Q]}),e[129]=Ve,e[130]=S,e[131]=Q,e[132]=V):V=e[132];let Z;e[133]!==o.length||e[134]!==Ze||e[135]!==n?(Z=o.length>0&&t.jsxs(Te,{onClick:Ze,variant:"outline",type:"button",children:[t.jsx(_t,{className:"h-4 w-4 mr-2"}),n("images.annotate.export")||"Export"]}),e[133]=o.length,e[134]=Ze,e[135]=n,e[136]=Z):Z=e[136];let ee;e[137]!==V||e[138]!==Z?(ee=t.jsxs("div",{className:"flex gap-2",children:[V,Z]}),e[137]=V,e[138]=Z,e[139]=ee):ee=e[139];let te;e[140]!==X||e[141]!==K||e[142]!==ee?(te=t.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[X,K,ee]}),e[140]=X,e[141]=K,e[142]=ee,e[143]=te):te=e[143];let se;e[144]!==n?(se=n("images.annotate.annotations")||"Annotations",e[144]=n,e[145]=se):se=e[145];let le;e[146]!==o.length||e[147]!==se?(le=t.jsxs("h2",{className:"text-sm font-semibold mb-3",children:[se," (",o.length,")"]}),e[146]=o.length,e[147]=se,e[148]=le):le=e[148];let ne;e[149]!==o||e[150]!==g||e[151]!==Qe||e[152]!==x||e[153]!==n?(ne=o.length===0?t.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:n("images.annotate.noAnnotations")||"No annotations yet"}):t.jsx("div",{className:"space-y-2 max-h-[600px] overflow-y-auto",children:o.map(s=>{const l=g.find(i=>i.id===s.label_id);return t.jsxs("div",{className:`rounded-lg border p-3 space-y-2 transition-colors cursor-pointer ${x===s.clientId?"bg-muted/80":"hover:bg-muted/50"}`,onClick:()=>nt(s.clientId),children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"h-3 w-3 rounded-full",style:{backgroundColor:l?.color}}),t.jsx("span",{className:"text-sm font-medium",children:l?.name||n("images.annotate.unknownLabel")||"Label"})]}),t.jsx(Te,{size:"sm",variant:"ghost",type:"button",onClick:i=>{i.stopPropagation(),Qe(s.clientId)},children:t.jsx(Ct,{className:"h-3 w-3"})})]}),t.jsxs("div",{className:"text-xs text-muted-foreground",children:["Position: (",Math.round(s.x),","," ",Math.round(s.y),")",t.jsx("br",{}),"Size: ",Math.round(s.width)," Ã—"," ",Math.round(s.height)]}),t.jsx(vt,{value:s.notes||"",onChange:i=>xt(s.clientId,i.target.value),placeholder:n("images.annotate.notesPlaceholder")||"Add notes...",rows:2,className:"text-xs",onClick:It})]},s.clientId)})}),e[149]=o,e[150]=g,e[151]=Qe,e[152]=x,e[153]=n,e[154]=ne):ne=e[154];let ie;e[155]!==le||e[156]!==ne?(ie=t.jsx("div",{className:"space-y-4",children:t.jsxs("div",{className:"rounded-xl border bg-card p-4 shadow-sm",children:[le,ne]})}),e[155]=le,e[156]=ne,e[157]=ie):ie=e[157];let ae;e[158]!==te||e[159]!==ie?(ae=t.jsxs("div",{className:"grid gap-4 lg:grid-cols-3",children:[te,ie]}),e[158]=te,e[159]=ie,e[160]=ae):ae=e[160];let oe;e[161]!==T||e[162]!==ae?(oe=t.jsxs("div",{className:"flex h-full flex-1 flex-col gap-4 overflow-x-auto rounded-xl p-4",children:[T,ae]}),e[161]=T,e[162]=ae,e[163]=oe):oe=e[163];let $e;return e[164]!==Je||e[165]!==k||e[166]!==oe?($e=t.jsxs(jt,{breadcrumbs:Je,children:[k,oe]}),e[164]=Je,e[165]=k,e[166]=oe,e[167]=$e):$e=e[167],$e}function It(a){return a.stopPropagation()}function kt(a){return{label_id:a.label_id,x:a.x,y:a.y,width:a.width,height:a.height,notes:a.notes}}function At(a){return{clientId:rt(a.id?`server-${a.id}`:"ann"),id:a.id,label_id:a.label_id,x:a.x,y:a.y,width:a.width,height:a.height,notes:a.notes??null}}export{os as default};
