import{r as S,j as o,H as xe,L as ye,a as we}from"./app-XseEcuwc.js";import{B}from"./button-DI4PaxQ7.js";import{T as Ce}from"./textarea-UpJGMb4k.js";import{A as Se}from"./app-layout-CZoO53OF.js";import{u as Me}from"./index-CR-rnG23.js";import Ee from"./create-label-dialog-Clj9cwyo.js";import{A as Ne}from"./arrow-left-CY72dKNG.js";import{P as je,a as Pe}from"./play-BTOxsHwB.js";import{T as ee}from"./trash-2-amZuM-2x.js";import{S as ke}from"./save-DfZnMHqC.js";import{D as De}from"./download-CEZ7BJdo.js";/* empty css            */import"./x-DgzPl7e4.js";import"./input-MwdOiVtB.js";import"./index-BHKBQx4H.js";import"./index-C3Hm02L2.js";import"./index-DRE42a0L.js";import"./index-BDsVhmEQ.js";import"./index-DPjtb1Rz.js";import"./select-Bhj_cBoa.js";import"./index-BitGjllA.js";import"./app-logo-icon-3mANveO6.js";import"./index-BZB35nAZ.js";import"./index-CMWG4mbA.js";import"./app-logo-BdIHiqic.js";import"./chevron-right-BMEIDfYh.js";import"./dialog-DBndcIzu.js";import"./label-DepknyqC.js";import"./loader-circle-v5nqKdhA.js";import"./plus-CF7Brvnu.js";function N(p,e,t,i){return new(t||(t=Promise))((function(s,n){function a(d){try{h(i.next(d))}catch(l){n(l)}}function c(d){try{h(i.throw(d))}catch(l){n(l)}}function h(d){var l;d.done?s(d.value):(l=d.value,l instanceof t?l:new t((function(f){f(l)}))).then(a,c)}h((i=i.apply(p,e||[])).next())}))}class F{constructor(){this.listeners={}}on(e,t,i){if(this.listeners[e]||(this.listeners[e]=new Set),this.listeners[e].add(t),i?.once){const s=()=>{this.un(e,s),this.un(e,t)};return this.on(e,s),s}return()=>this.un(e,t)}un(e,t){var i;(i=this.listeners[e])===null||i===void 0||i.delete(t)}once(e,t){return this.on(e,t,{once:!0})}unAll(){this.listeners={}}emit(e,...t){this.listeners[e]&&this.listeners[e].forEach((i=>i(...t)))}}const te={decode:function(p,e){return N(this,void 0,void 0,(function*(){const t=new AudioContext({sampleRate:e});return t.decodeAudioData(p).finally((()=>t.close()))}))},createBuffer:function(p,e){return typeof p[0]=="number"&&(p=[p]),(function(t){const i=t[0];if(i.some((s=>s>1||s<-1))){const s=i.length;let n=0;for(let a=0;a<s;a++){const c=Math.abs(i[a]);c>n&&(n=c)}for(const a of t)for(let c=0;c<s;c++)a[c]/=n}})(p),{duration:e,length:p[0].length,sampleRate:p[0].length/e,numberOfChannels:p.length,getChannelData:t=>p?.[t],copyFromChannel:AudioBuffer.prototype.copyFromChannel,copyToChannel:AudioBuffer.prototype.copyToChannel}}};function re(p,e){const t=e.xmlns?document.createElementNS(e.xmlns,p):document.createElement(p);for(const[i,s]of Object.entries(e))if(i==="children")for(const[n,a]of Object.entries(e))typeof a=="string"?t.appendChild(document.createTextNode(a)):t.appendChild(re(n,a));else i==="style"?Object.assign(t.style,s):i==="textContent"?t.textContent=s:t.setAttribute(i,s.toString());return t}function ie(p,e,t){const i=re(p,e||{});return t?.appendChild(i),i}var Te=Object.freeze({__proto__:null,createElement:ie,default:ie});const Re={fetchBlob:function(p,e,t){return N(this,void 0,void 0,(function*(){const i=yield fetch(p,t);if(i.status>=400)throw new Error(`Failed to fetch ${p}: ${i.status} (${i.statusText})`);return(function(s,n){N(this,void 0,void 0,(function*(){if(!s.body||!s.headers)return;const a=s.body.getReader(),c=Number(s.headers.get("Content-Length"))||0;let h=0;const d=f=>N(this,void 0,void 0,(function*(){h+=f?.length||0;const m=Math.round(h/c*100);n(m)})),l=()=>N(this,void 0,void 0,(function*(){let f;try{f=yield a.read()}catch{return}f.done||(d(f.value),yield l())}));l()}))})(i.clone(),e),i.blob()}))}};class Le extends F{constructor(e){super(),this.isExternalMedia=!1,e.media?(this.media=e.media,this.isExternalMedia=!0):this.media=document.createElement("audio"),e.mediaControls&&(this.media.controls=!0),e.autoplay&&(this.media.autoplay=!0),e.playbackRate!=null&&this.onMediaEvent("canplay",(()=>{e.playbackRate!=null&&(this.media.playbackRate=e.playbackRate)}),{once:!0})}onMediaEvent(e,t,i){return this.media.addEventListener(e,t,i),()=>this.media.removeEventListener(e,t,i)}getSrc(){return this.media.currentSrc||this.media.src||""}revokeSrc(){const e=this.getSrc();e.startsWith("blob:")&&URL.revokeObjectURL(e)}canPlayType(e){return this.media.canPlayType(e)!==""}setSrc(e,t){const i=this.getSrc();if(e&&i===e)return;this.revokeSrc();const s=t instanceof Blob&&(this.canPlayType(t.type)||!e)?URL.createObjectURL(t):e;try{this.media.src=s}catch{this.media.src=e}}destroy(){this.media.pause(),this.isExternalMedia||(this.media.remove(),this.revokeSrc(),this.media.src="",this.media.load())}setMediaElement(e){this.media=e}play(){return N(this,void 0,void 0,(function*(){return this.media.play()}))}pause(){this.media.pause()}isPlaying(){return!this.media.paused&&!this.media.ended}setTime(e){this.media.currentTime=e}getDuration(){return this.media.duration}getCurrentTime(){return this.media.currentTime}getVolume(){return this.media.volume}setVolume(e){this.media.volume=e}getMuted(){return this.media.muted}setMuted(e){this.media.muted=e}getPlaybackRate(){return this.media.playbackRate}isSeeking(){return this.media.seeking}setPlaybackRate(e,t){t!=null&&(this.media.preservesPitch=t),this.media.playbackRate=e}getMediaElement(){return this.media}setSinkId(e){return this.media.setSinkId(e)}}class $ extends F{constructor(e,t){super(),this.timeouts=[],this.isScrollable=!1,this.audioData=null,this.resizeObserver=null,this.lastContainerWidth=0,this.isDragging=!1,this.subscriptions=[],this.subscriptions=[],this.options=e;const i=this.parentFromOptionsContainer(e.container);this.parent=i;const[s,n]=this.initHtml();i.appendChild(s),this.container=s,this.scrollContainer=n.querySelector(".scroll"),this.wrapper=n.querySelector(".wrapper"),this.canvasWrapper=n.querySelector(".canvases"),this.progressWrapper=n.querySelector(".progress"),this.cursor=n.querySelector(".cursor"),t&&n.appendChild(t),this.initEvents()}parentFromOptionsContainer(e){let t;if(typeof e=="string"?t=document.querySelector(e):e instanceof HTMLElement&&(t=e),!t)throw new Error("Container not found");return t}initEvents(){const e=t=>{const i=this.wrapper.getBoundingClientRect(),s=t.clientX-i.left,n=t.clientY-i.top;return[s/i.width,n/i.height]};if(this.wrapper.addEventListener("click",(t=>{const[i,s]=e(t);this.emit("click",i,s)})),this.wrapper.addEventListener("dblclick",(t=>{const[i,s]=e(t);this.emit("dblclick",i,s)})),this.options.dragToSeek!==!0&&typeof this.options.dragToSeek!="object"||this.initDrag(),this.scrollContainer.addEventListener("scroll",(()=>{const{scrollLeft:t,scrollWidth:i,clientWidth:s}=this.scrollContainer,n=t/i,a=(t+s)/i;this.emit("scroll",n,a,t,t+s)})),typeof ResizeObserver=="function"){const t=this.createDelay(100);this.resizeObserver=new ResizeObserver((()=>{t().then((()=>this.onContainerResize())).catch((()=>{}))})),this.resizeObserver.observe(this.scrollContainer)}}onContainerResize(){const e=this.parent.clientWidth;e===this.lastContainerWidth&&this.options.height!=="auto"||(this.lastContainerWidth=e,this.reRender())}initDrag(){this.subscriptions.push((function(e,t,i,s,n=3,a=0,c=100){if(!e)return()=>{};const h=matchMedia("(pointer: coarse)").matches;let d=()=>{};const l=f=>{if(f.button!==a)return;f.preventDefault(),f.stopPropagation();let m=f.clientX,g=f.clientY,v=!1;const k=Date.now(),C=x=>{if(x.preventDefault(),x.stopPropagation(),h&&Date.now()-k<c)return;const P=x.clientX,D=x.clientY,L=P-m,T=D-g;if(v||Math.abs(L)>n||Math.abs(T)>n){const _=e.getBoundingClientRect(),{left:W,top:A}=_;v||(i?.(m-W,g-A),v=!0),t(L,T,P-W,D-A),m=P,g=D}},y=x=>{if(v){const P=x.clientX,D=x.clientY,L=e.getBoundingClientRect(),{left:T,top:_}=L;s?.(P-T,D-_)}d()},E=x=>{x.relatedTarget&&x.relatedTarget!==document.documentElement||y(x)},R=x=>{v&&(x.stopPropagation(),x.preventDefault())},j=x=>{v&&x.preventDefault()};document.addEventListener("pointermove",C),document.addEventListener("pointerup",y),document.addEventListener("pointerout",E),document.addEventListener("pointercancel",E),document.addEventListener("touchmove",j,{passive:!1}),document.addEventListener("click",R,{capture:!0}),d=()=>{document.removeEventListener("pointermove",C),document.removeEventListener("pointerup",y),document.removeEventListener("pointerout",E),document.removeEventListener("pointercancel",E),document.removeEventListener("touchmove",j),setTimeout((()=>{document.removeEventListener("click",R,{capture:!0})}),10)}};return e.addEventListener("pointerdown",l),()=>{d(),e.removeEventListener("pointerdown",l)}})(this.wrapper,((e,t,i)=>{this.emit("drag",Math.max(0,Math.min(1,i/this.wrapper.getBoundingClientRect().width)))}),(e=>{this.isDragging=!0,this.emit("dragstart",Math.max(0,Math.min(1,e/this.wrapper.getBoundingClientRect().width)))}),(e=>{this.isDragging=!1,this.emit("dragend",Math.max(0,Math.min(1,e/this.wrapper.getBoundingClientRect().width)))})))}getHeight(e,t){var i;const s=((i=this.audioData)===null||i===void 0?void 0:i.numberOfChannels)||1;if(e==null)return 128;if(!isNaN(Number(e)))return Number(e);if(e==="auto"){const n=this.parent.clientHeight||128;return t?.every((a=>!a.overlay))?n/s:n}return 128}initHtml(){const e=document.createElement("div"),t=e.attachShadow({mode:"open"});return t.innerHTML=`
      <style>
        :host {
          user-select: none;
          min-width: 1px;
        }
        :host audio {
          display: block;
          width: 100%;
        }
        :host .scroll {
          overflow-x: auto;
          overflow-y: hidden;
          width: 100%;
          position: relative;
        }
        :host .noScrollbar {
          scrollbar-color: transparent;
          scrollbar-width: none;
        }
        :host .noScrollbar::-webkit-scrollbar {
          display: none;
          -webkit-appearance: none;
        }
        :host .wrapper {
          position: relative;
          overflow: visible;
          z-index: 2;
        }
        :host .canvases {
          min-height: ${this.getHeight(this.options.height,this.options.splitChannels)}px;
        }
        :host .canvases > div {
          position: relative;
        }
        :host canvas {
          display: block;
          position: absolute;
          top: 0;
          image-rendering: pixelated;
        }
        :host .progress {
          pointer-events: none;
          position: absolute;
          z-index: 2;
          top: 0;
          left: 0;
          width: 0;
          height: 100%;
          overflow: hidden;
        }
        :host .progress > div {
          position: relative;
        }
        :host .cursor {
          pointer-events: none;
          position: absolute;
          z-index: 5;
          top: 0;
          left: 0;
          height: 100%;
          border-radius: 2px;
        }
      </style>

      <div class="scroll" part="scroll">
        <div class="wrapper" part="wrapper">
          <div class="canvases" part="canvases"></div>
          <div class="progress" part="progress"></div>
          <div class="cursor" part="cursor"></div>
        </div>
      </div>
    `,[e,t]}setOptions(e){if(this.options.container!==e.container){const t=this.parentFromOptionsContainer(e.container);t.appendChild(this.container),this.parent=t}e.dragToSeek!==!0&&typeof this.options.dragToSeek!="object"||this.initDrag(),this.options=e,this.reRender()}getWrapper(){return this.wrapper}getWidth(){return this.scrollContainer.clientWidth}getScroll(){return this.scrollContainer.scrollLeft}setScroll(e){this.scrollContainer.scrollLeft=e}setScrollPercentage(e){const{scrollWidth:t}=this.scrollContainer,i=t*e;this.setScroll(i)}destroy(){var e,t;this.subscriptions.forEach((i=>i())),this.container.remove(),(e=this.resizeObserver)===null||e===void 0||e.disconnect(),(t=this.unsubscribeOnScroll)===null||t===void 0||t.call(this)}createDelay(e=10){let t,i;const s=()=>{t&&clearTimeout(t),i&&i()};return this.timeouts.push(s),()=>new Promise(((n,a)=>{s(),i=a,t=setTimeout((()=>{t=void 0,i=void 0,n()}),e)}))}convertColorValues(e){if(!Array.isArray(e))return e||"";if(e.length<2)return e[0]||"";const t=document.createElement("canvas"),i=t.getContext("2d"),s=t.height*(window.devicePixelRatio||1),n=i.createLinearGradient(0,0,0,s),a=1/(e.length-1);return e.forEach(((c,h)=>{const d=h*a;n.addColorStop(d,c)})),n}getPixelRatio(){return Math.max(1,window.devicePixelRatio||1)}renderBarWaveform(e,t,i,s){const n=e[0],a=e[1]||e[0],c=n.length,{width:h,height:d}=i.canvas,l=d/2,f=this.getPixelRatio(),m=t.barWidth?t.barWidth*f:1,g=t.barGap?t.barGap*f:t.barWidth?m/2:0,v=t.barRadius||0,k=h/(m+g)/c,C=v&&"roundRect"in i?"roundRect":"rect";i.beginPath();let y=0,E=0,R=0;for(let j=0;j<=c;j++){const x=Math.round(j*k);if(x>y){const L=Math.round(E*l*s),T=L+Math.round(R*l*s)||1;let _=l-L;t.barAlign==="top"?_=0:t.barAlign==="bottom"&&(_=d-T),i[C](y*(m+g),_,m,T,v),y=x,E=0,R=0}const P=Math.abs(n[j]||0),D=Math.abs(a[j]||0);P>E&&(E=P),D>R&&(R=D)}i.fill(),i.closePath()}renderLineWaveform(e,t,i,s){const n=a=>{const c=e[a]||e[0],h=c.length,{height:d}=i.canvas,l=d/2,f=i.canvas.width/h;i.moveTo(0,l);let m=0,g=0;for(let v=0;v<=h;v++){const k=Math.round(v*f);if(k>m){const y=l+(Math.round(g*l*s)||1)*(a===0?-1:1);i.lineTo(m,y),m=k,g=0}const C=Math.abs(c[v]||0);C>g&&(g=C)}i.lineTo(m,l)};i.beginPath(),n(0),n(1),i.fill(),i.closePath()}renderWaveform(e,t,i){if(i.fillStyle=this.convertColorValues(t.waveColor),t.renderFunction)return void t.renderFunction(e,i);let s=t.barHeight||1;if(t.normalize){const n=Array.from(e[0]).reduce(((a,c)=>Math.max(a,Math.abs(c))),0);s=n?1/n:1}t.barWidth||t.barGap||t.barAlign?this.renderBarWaveform(e,t,i,s):this.renderLineWaveform(e,t,i,s)}renderSingleCanvas(e,t,i,s,n,a,c){const h=this.getPixelRatio(),d=document.createElement("canvas");d.width=Math.round(i*h),d.height=Math.round(s*h),d.style.width=`${i}px`,d.style.height=`${s}px`,d.style.left=`${Math.round(n)}px`,a.appendChild(d);const l=d.getContext("2d");if(this.renderWaveform(e,t,l),d.width>0&&d.height>0){const f=d.cloneNode(),m=f.getContext("2d");m.drawImage(d,0,0),m.globalCompositeOperation="source-in",m.fillStyle=this.convertColorValues(t.progressColor),m.fillRect(0,0,d.width,d.height),c.appendChild(f)}}renderMultiCanvas(e,t,i,s,n,a){const c=this.getPixelRatio(),{clientWidth:h}=this.scrollContainer;if(h*c>=i)return void this.renderSingleCanvas(e,t,h,s,0,n,a);const d=i/c;let l=Math.min($.MAX_CANVAS_WIDTH,h,d),f={};if(t.barWidth||t.barGap){const C=t.barWidth||.5,y=C+(t.barGap||C/2);l%y!=0&&(l=Math.floor(l/y)*y)}const m=C=>{if(C<0||C>=g||f[C])return;f[C]=!0;const y=C*l,E=Math.min(d-y,l);if(E<=0)return;const R=e.map((j=>{const x=Math.floor(y/d*j.length),P=Math.floor((y+E)/d*j.length);return j.slice(x,P)}));this.renderSingleCanvas(R,t,E,s,y,n,a)},g=Math.ceil(d/l),v=this.scrollContainer.scrollLeft/d,k=Math.floor(v*g);m(k-1),m(k),m(k+1),g>1&&(this.unsubscribeOnScroll=this.on("scroll",(()=>{const{scrollLeft:C}=this.scrollContainer,y=Math.floor(C/d*g);Object.keys(f).length>$.MAX_NODES&&(n.innerHTML="",a.innerHTML="",f={}),m(y-1),m(y),m(y+1)})))}renderChannel(e,t,i,s){var{overlay:n}=t,a=(function(l,f){var m={};for(var g in l)Object.prototype.hasOwnProperty.call(l,g)&&f.indexOf(g)<0&&(m[g]=l[g]);if(l!=null&&typeof Object.getOwnPropertySymbols=="function"){var v=0;for(g=Object.getOwnPropertySymbols(l);v<g.length;v++)f.indexOf(g[v])<0&&Object.prototype.propertyIsEnumerable.call(l,g[v])&&(m[g[v]]=l[g[v]])}return m})(t,["overlay"]);const c=document.createElement("div"),h=this.getHeight(a.height,a.splitChannels);c.style.height=`${h}px`,n&&s>0&&(c.style.marginTop=`-${h}px`),this.canvasWrapper.style.minHeight=`${h}px`,this.canvasWrapper.appendChild(c);const d=c.cloneNode();this.progressWrapper.appendChild(d),this.renderMultiCanvas(e,a,i,h,c,d)}render(e){return N(this,void 0,void 0,(function*(){var t;this.timeouts.forEach((h=>h())),this.timeouts=[],this.canvasWrapper.innerHTML="",this.progressWrapper.innerHTML="",this.options.width!=null&&(this.scrollContainer.style.width=typeof this.options.width=="number"?`${this.options.width}px`:this.options.width);const i=this.getPixelRatio(),s=this.scrollContainer.clientWidth,n=Math.ceil(e.duration*(this.options.minPxPerSec||0));this.isScrollable=n>s;const a=this.options.fillParent&&!this.isScrollable,c=(a?s:n)*i;if(this.wrapper.style.width=a?"100%":`${n}px`,this.scrollContainer.style.overflowX=this.isScrollable?"auto":"hidden",this.scrollContainer.classList.toggle("noScrollbar",!!this.options.hideScrollbar),this.cursor.style.backgroundColor=`${this.options.cursorColor||this.options.progressColor}`,this.cursor.style.width=`${this.options.cursorWidth}px`,this.audioData=e,this.emit("render"),this.options.splitChannels)for(let h=0;h<e.numberOfChannels;h++){const d=Object.assign(Object.assign({},this.options),(t=this.options.splitChannels)===null||t===void 0?void 0:t[h]);this.renderChannel([e.getChannelData(h)],d,c,h)}else{const h=[e.getChannelData(0)];e.numberOfChannels>1&&h.push(e.getChannelData(1)),this.renderChannel(h,this.options,c,0)}Promise.resolve().then((()=>this.emit("rendered")))}))}reRender(){var e;if((e=this.unsubscribeOnScroll)===null||e===void 0||e.call(this),delete this.unsubscribeOnScroll,!this.audioData)return;const{scrollWidth:t}=this.scrollContainer,{right:i}=this.progressWrapper.getBoundingClientRect();if(this.render(this.audioData),this.isScrollable&&t!==this.scrollContainer.scrollWidth){const{right:s}=this.progressWrapper.getBoundingClientRect();let n=s-i;n*=2,n=n<0?Math.floor(n):Math.ceil(n),n/=2,this.scrollContainer.scrollLeft+=n}}zoom(e){this.options.minPxPerSec=e,this.reRender()}scrollIntoView(e,t=!1){const{scrollLeft:i,scrollWidth:s,clientWidth:n}=this.scrollContainer,a=e*s,c=i,h=i+n,d=n/2;if(this.isDragging)a+30>h?this.scrollContainer.scrollLeft+=30:a-30<c&&(this.scrollContainer.scrollLeft-=30);else{(a<c||a>h)&&(this.scrollContainer.scrollLeft=a-(this.options.autoCenter?d:0));const l=a-i-d;t&&this.options.autoCenter&&l>0&&(this.scrollContainer.scrollLeft+=Math.min(l,10))}{const l=this.scrollContainer.scrollLeft,f=l/s,m=(l+n)/s;this.emit("scroll",f,m,l,l+n)}}renderProgress(e,t){if(isNaN(e))return;const i=100*e;this.canvasWrapper.style.clipPath=`polygon(${i}% 0, 100% 0, 100% 100%, ${i}% 100%)`,this.progressWrapper.style.width=`${i}%`,this.cursor.style.left=`${i}%`,this.cursor.style.transform=`translateX(-${Math.round(i)===100?this.options.cursorWidth:0}px)`,this.isScrollable&&this.options.autoScroll&&this.scrollIntoView(e,t)}exportImage(e,t,i){return N(this,void 0,void 0,(function*(){const s=this.canvasWrapper.querySelectorAll("canvas");if(!s.length)throw new Error("No waveform data");if(i==="dataURL"){const n=Array.from(s).map((a=>a.toDataURL(e,t)));return Promise.resolve(n)}return Promise.all(Array.from(s).map((n=>new Promise(((a,c)=>{n.toBlob((h=>{h?a(h):c(new Error("Could not export image"))}),e,t)})))))}))}}$.MAX_CANVAS_WIDTH=8e3,$.MAX_NODES=10;class _e extends F{constructor(){super(...arguments),this.unsubscribe=()=>{}}start(){this.unsubscribe=this.on("tick",(()=>{requestAnimationFrame((()=>{this.emit("tick")}))})),this.emit("tick")}stop(){this.unsubscribe()}destroy(){this.unsubscribe()}}class se extends F{constructor(e=new AudioContext){super(),this.bufferNode=null,this.playStartTime=0,this.playedDuration=0,this._muted=!1,this._playbackRate=1,this._duration=void 0,this.buffer=null,this.currentSrc="",this.paused=!0,this.crossOrigin=null,this.seeking=!1,this.autoplay=!1,this.addEventListener=this.on,this.removeEventListener=this.un,this.audioContext=e,this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination)}load(){return N(this,void 0,void 0,(function*(){}))}get src(){return this.currentSrc}set src(e){if(this.currentSrc=e,this._duration=void 0,!e)return this.buffer=null,void this.emit("emptied");fetch(e).then((t=>{if(t.status>=400)throw new Error(`Failed to fetch ${e}: ${t.status} (${t.statusText})`);return t.arrayBuffer()})).then((t=>this.currentSrc!==e?null:this.audioContext.decodeAudioData(t))).then((t=>{this.currentSrc===e&&(this.buffer=t,this.emit("loadedmetadata"),this.emit("canplay"),this.autoplay&&this.play())}))}_play(){var e;if(!this.paused)return;this.paused=!1,(e=this.bufferNode)===null||e===void 0||e.disconnect(),this.bufferNode=this.audioContext.createBufferSource(),this.buffer&&(this.bufferNode.buffer=this.buffer),this.bufferNode.playbackRate.value=this._playbackRate,this.bufferNode.connect(this.gainNode);let t=this.playedDuration*this._playbackRate;t>=this.duration&&(t=0,this.playedDuration=0),this.bufferNode.start(this.audioContext.currentTime,t),this.playStartTime=this.audioContext.currentTime,this.bufferNode.onended=()=>{this.currentTime>=this.duration&&(this.pause(),this.emit("ended"))}}_pause(){var e;this.paused=!0,(e=this.bufferNode)===null||e===void 0||e.stop(),this.playedDuration+=this.audioContext.currentTime-this.playStartTime}play(){return N(this,void 0,void 0,(function*(){this.paused&&(this._play(),this.emit("play"))}))}pause(){this.paused||(this._pause(),this.emit("pause"))}stopAt(e){var t,i;const s=e-this.currentTime;(t=this.bufferNode)===null||t===void 0||t.stop(this.audioContext.currentTime+s),(i=this.bufferNode)===null||i===void 0||i.addEventListener("ended",(()=>{this.bufferNode=null,this.pause()}),{once:!0})}setSinkId(e){return N(this,void 0,void 0,(function*(){return this.audioContext.setSinkId(e)}))}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e,this.bufferNode&&(this.bufferNode.playbackRate.value=e)}get currentTime(){return(this.paused?this.playedDuration:this.playedDuration+(this.audioContext.currentTime-this.playStartTime))*this._playbackRate}set currentTime(e){const t=!this.paused;t&&this._pause(),this.playedDuration=e/this._playbackRate,t&&this._play(),this.emit("seeking"),this.emit("timeupdate")}get duration(){var e,t;return(e=this._duration)!==null&&e!==void 0?e:((t=this.buffer)===null||t===void 0?void 0:t.duration)||0}set duration(e){this._duration=e}get volume(){return this.gainNode.gain.value}set volume(e){this.gainNode.gain.value=e,this.emit("volumechange")}get muted(){return this._muted}set muted(e){this._muted!==e&&(this._muted=e,this._muted?this.gainNode.disconnect():this.gainNode.connect(this.audioContext.destination))}canPlayType(e){return/^(audio|video)\//.test(e)}getGainNode(){return this.gainNode}getChannelData(){const e=[];if(!this.buffer)return e;const t=this.buffer.numberOfChannels;for(let i=0;i<t;i++)e.push(this.buffer.getChannelData(i));return e}}const We={waveColor:"#999",progressColor:"#555",cursorWidth:1,minPxPerSec:0,fillParent:!0,interact:!0,dragToSeek:!1,autoScroll:!0,autoCenter:!0,sampleRate:8e3};class H extends Le{static create(e){return new H(e)}constructor(e){const t=e.media||(e.backend==="WebAudio"?new se:void 0);super({media:t,mediaControls:e.mediaControls,autoplay:e.autoplay,playbackRate:e.audioRate}),this.plugins=[],this.decodedData=null,this.subscriptions=[],this.mediaSubscriptions=[],this.abortController=null,this.options=Object.assign({},We,e),this.timer=new _e;const i=t?void 0:this.getMediaElement();this.renderer=new $(this.options,i),this.initPlayerEvents(),this.initRendererEvents(),this.initTimerEvents(),this.initPlugins();const s=this.options.url||this.getSrc()||"";Promise.resolve().then((()=>{this.emit("init");const{peaks:n,duration:a}=this.options;(s||n&&a)&&this.load(s,n,a).catch((()=>null))}))}updateProgress(e=this.getCurrentTime()){return this.renderer.renderProgress(e/this.getDuration(),this.isPlaying()),e}initTimerEvents(){this.subscriptions.push(this.timer.on("tick",(()=>{if(!this.isSeeking()){const e=this.updateProgress();this.emit("timeupdate",e),this.emit("audioprocess",e)}})))}initPlayerEvents(){this.isPlaying()&&(this.emit("play"),this.timer.start()),this.mediaSubscriptions.push(this.onMediaEvent("timeupdate",(()=>{const e=this.updateProgress();this.emit("timeupdate",e)})),this.onMediaEvent("play",(()=>{this.emit("play"),this.timer.start()})),this.onMediaEvent("pause",(()=>{this.emit("pause"),this.timer.stop()})),this.onMediaEvent("emptied",(()=>{this.timer.stop()})),this.onMediaEvent("ended",(()=>{this.emit("finish")})),this.onMediaEvent("seeking",(()=>{this.emit("seeking",this.getCurrentTime())})),this.onMediaEvent("error",(e=>{this.emit("error",e.error)})))}initRendererEvents(){this.subscriptions.push(this.renderer.on("click",((e,t)=>{this.options.interact&&(this.seekTo(e),this.emit("interaction",e*this.getDuration()),this.emit("click",e,t))})),this.renderer.on("dblclick",((e,t)=>{this.emit("dblclick",e,t)})),this.renderer.on("scroll",((e,t,i,s)=>{const n=this.getDuration();this.emit("scroll",e*n,t*n,i,s)})),this.renderer.on("render",(()=>{this.emit("redraw")})),this.renderer.on("rendered",(()=>{this.emit("redrawcomplete")})),this.renderer.on("dragstart",(e=>{this.emit("dragstart",e)})),this.renderer.on("dragend",(e=>{this.emit("dragend",e)})));{let e;this.subscriptions.push(this.renderer.on("drag",(t=>{if(!this.options.interact)return;let i;this.renderer.renderProgress(t),clearTimeout(e),this.isPlaying()?i=0:this.options.dragToSeek===!0?i=200:typeof this.options.dragToSeek=="object"&&this.options.dragToSeek!==void 0&&(i=this.options.dragToSeek.debounceTime),e=setTimeout((()=>{this.seekTo(t)}),i),this.emit("interaction",t*this.getDuration()),this.emit("drag",t)})))}}initPlugins(){var e;!((e=this.options.plugins)===null||e===void 0)&&e.length&&this.options.plugins.forEach((t=>{this.registerPlugin(t)}))}unsubscribePlayerEvents(){this.mediaSubscriptions.forEach((e=>e())),this.mediaSubscriptions=[]}setOptions(e){this.options=Object.assign({},this.options,e),this.renderer.setOptions(this.options),e.audioRate&&this.setPlaybackRate(e.audioRate),e.mediaControls!=null&&(this.getMediaElement().controls=e.mediaControls)}registerPlugin(e){return e._init(this),this.plugins.push(e),this.subscriptions.push(e.once("destroy",(()=>{this.plugins=this.plugins.filter((t=>t!==e))}))),e}getWrapper(){return this.renderer.getWrapper()}getWidth(){return this.renderer.getWidth()}getScroll(){return this.renderer.getScroll()}setScroll(e){return this.renderer.setScroll(e)}setScrollTime(e){const t=e/this.getDuration();this.renderer.setScrollPercentage(t)}getActivePlugins(){return this.plugins}loadAudio(e,t,i,s){return N(this,void 0,void 0,(function*(){var n;if(this.emit("load",e),!this.options.media&&this.isPlaying()&&this.pause(),this.decodedData=null,!t&&!i){const c=this.options.fetchParams||{};window.AbortController&&!c.signal&&(this.abortController=new AbortController,c.signal=(n=this.abortController)===null||n===void 0?void 0:n.signal);const h=d=>this.emit("loading",d);t=yield Re.fetchBlob(e,h,c)}this.setSrc(e,t);const a=yield new Promise((c=>{const h=s||this.getDuration();h?c(h):this.mediaSubscriptions.push(this.onMediaEvent("loadedmetadata",(()=>c(this.getDuration())),{once:!0}))}));if(!e&&!t){const c=this.getMediaElement();c instanceof se&&(c.duration=a)}if(i)this.decodedData=te.createBuffer(i,a||0);else if(t){const c=yield t.arrayBuffer();this.decodedData=yield te.decode(c,this.options.sampleRate)}this.decodedData&&(this.emit("decode",this.getDuration()),this.renderer.render(this.decodedData)),this.emit("ready",this.getDuration())}))}load(e,t,i){return N(this,void 0,void 0,(function*(){try{return yield this.loadAudio(e,void 0,t,i)}catch(s){throw this.emit("error",s),s}}))}loadBlob(e,t,i){return N(this,void 0,void 0,(function*(){try{return yield this.loadAudio("",e,t,i)}catch(s){throw this.emit("error",s),s}}))}zoom(e){if(!this.decodedData)throw new Error("No audio loaded");this.renderer.zoom(e),this.emit("zoom",e)}getDecodedData(){return this.decodedData}exportPeaks({channels:e=2,maxLength:t=8e3,precision:i=1e4}={}){if(!this.decodedData)throw new Error("The audio has not been decoded yet");const s=Math.min(e,this.decodedData.numberOfChannels),n=[];for(let a=0;a<s;a++){const c=this.decodedData.getChannelData(a),h=[],d=c.length/t;for(let l=0;l<t;l++){const f=c.slice(Math.floor(l*d),Math.ceil((l+1)*d));let m=0;for(let g=0;g<f.length;g++){const v=f[g];Math.abs(v)>Math.abs(m)&&(m=v)}h.push(Math.round(m*i)/i)}n.push(h)}return n}getDuration(){let e=super.getDuration()||0;return e!==0&&e!==1/0||!this.decodedData||(e=this.decodedData.duration),e}toggleInteraction(e){this.options.interact=e}setTime(e){super.setTime(e),this.updateProgress(e),this.emit("timeupdate",e)}seekTo(e){const t=this.getDuration()*e;this.setTime(t)}playPause(){return N(this,void 0,void 0,(function*(){return this.isPlaying()?this.pause():this.play()}))}stop(){this.pause(),this.setTime(0)}skip(e){this.setTime(this.getCurrentTime()+e)}empty(){this.load("",[[0]],.001)}setMediaElement(e){this.unsubscribePlayerEvents(),super.setMediaElement(e),this.initPlayerEvents()}exportImage(){return N(this,arguments,void 0,(function*(e="image/png",t=1,i="dataURL"){return this.renderer.exportImage(e,t,i)}))}destroy(){var e;this.emit("destroy"),(e=this.abortController)===null||e===void 0||e.abort(),this.plugins.forEach((t=>t.destroy())),this.subscriptions.forEach((t=>t())),this.unsubscribePlayerEvents(),this.timer.destroy(),this.renderer.destroy(),super.destroy()}}H.BasePlugin=class extends F{constructor(p){super(),this.subscriptions=[],this.options=p}onInit(){}_init(p){this.wavesurfer=p,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach((p=>p()))}},H.dom=Te;function ne(p="seg"){return typeof crypto<"u"&&"randomUUID"in crypto?`${p}-${crypto.randomUUID()}`:`${p}-${Date.now()}-${Math.random().toString(16).slice(2)}`}function ut({audio:p,labels:e}){const{t}=Me(),i=S.useRef(null),s=S.useRef(null),n=S.useRef(null),[a,c]=S.useState(!1),[h,d]=S.useState(0),[l,f]=S.useState(p.duration_seconds??0),[m,g]=S.useState(800),v=S.useRef(null),[k,C]=S.useState(e),[y,E]=S.useState(e[0]||null),[R,j]=S.useState(!1),[x,P]=S.useState(()=>(p.segments||[]).map(r=>({clientId:ne(r.id?`server-${r.id}`:"seg"),id:r.id,label_id:r.label_id,start_time:r.start_time,end_time:r.end_time,notes:r.notes??null}))),[D,L]=S.useState(!1),[T,_]=S.useState(0),[W,A]=S.useState(0),[I,Y]=S.useState(null),[J,X]=S.useState(!1),oe=[{title:t("audios.title"),href:"/researcher/audios"},{title:p.title||p.original_filename,href:`/researcher/audios/${p.id}`},{title:t("audios.label.title"),href:`/researcher/audios/${p.id}/label`}],z=r=>{if(!r||Number.isNaN(r))return"0:00";const u=Math.floor(r/60),b=Math.floor(r%60);return`${u}:${b.toString().padStart(2,"0")}`},U=()=>{i.current&&g(i.current.clientWidth)},ae=r=>{if(!l||!m)return{left:0,width:0,visible:!1};const u=r.start_time/l,b=r.end_time/l,w=u*m,M=Math.max(2,(b-u)*m);return{left:w,width:M,visible:M>0}},V=r=>!m||!l?0:Math.max(0,Math.min(r/m,1))*l;S.useEffect(()=>{if(!s.current||!p.url)return;if(n.current){try{n.current.destroy()}catch(u){console.error(u)}n.current=null}const r=H.create({container:s.current,height:120,waveColor:"#e2e8f0",progressColor:"#3b82f6",cursorColor:"#1f2937",normalize:!0});return r.load(p.url),n.current=r,r.on("ready",()=>{const u=r.getDuration();f(u),U()}),r.on("play",()=>c(!0)),r.on("pause",()=>c(!1)),r.on("audioprocess",u=>{d(u),v.current!==null&&u>=v.current-.01&&(r.pause(),v.current=null)}),window.addEventListener("resize",U),()=>{if(window.removeEventListener("resize",U),n.current)try{n.current.destroy()}catch(u){u instanceof DOMException&&u.name==="AbortError"?console.warn("WaveSurfer destroy aborted (safe to ignore)"):console.error(u)}finally{n.current=null}}},[p.url]),S.useEffect(()=>{U()},[]);const le=()=>{const r=n.current;r&&r.playPause()},ce=r=>{const u=n.current;u&&(u.setTime(r.start_time),v.current=r.end_time,u.play())},de=(r,u)=>{if(!y)return;const b={clientId:ne("seg"),label_id:y.id,start_time:Math.min(r,u),end_time:Math.max(r,u),notes:null};P(w=>[...w,b].sort((M,q)=>M.start_time-q.start_time))},K=r=>{P(u=>u.filter(b=>b.clientId!==r))},he=(r,u)=>{P(b=>b.map(w=>w.clientId===r?{...w,notes:u}:w))},Q=(r,u,b)=>{b.preventDefault(),b.stopPropagation(),Y({clientId:r.clientId,mode:u})};S.useEffect(()=>{if(!I)return;const r=b=>{const w=i.current;if(!w||!l)return;const M=w.getBoundingClientRect(),q=b.clientX-M.left,Z=V(q);P(be=>be.map(O=>{if(O.clientId!==I.clientId)return O;if(I.mode==="start"){const G=Math.max(0,Math.min(Z,O.end_time-.1));return{...O,start_time:G}}else{const G=Math.max(O.start_time+.1,Math.min(Z,l));return{...O,end_time:G}}}))},u=()=>{Y(null)};return document.addEventListener("mousemove",r),document.addEventListener("mouseup",u),()=>{document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",u)}},[I,l]);const ue=r=>{if(!y||I)return;const u=i.current;if(!u)return;const b=u.getBoundingClientRect(),w=r.clientX-b.left;L(!0),_(w),A(w)},pe=r=>{if(!D)return;const u=i.current;if(!u)return;const b=u.getBoundingClientRect(),w=r.clientX-b.left;A(w)},me=()=>{if(!D||(L(!1),!i.current||!l))return;const u=Math.min(T,W),b=Math.max(T,W);if(Math.abs(b-u)<3)return;const w=V(u),M=V(b);Math.abs(M-w)>.1&&de(w,M)},fe=()=>{X(!0),we.put(`/researcher/audios/${p.id}/segments`,{segments:x.map(r=>({label_id:r.label_id,start_time:r.start_time,end_time:r.end_time,notes:r.notes}))},{onSuccess:()=>X(!1),onError:()=>X(!1)})},ge=()=>{window.location.href=`/researcher/audios/${p.id}/export`},ve=r=>{C(u=>u.some(b=>b.id===r.id)?u:[...u,r]),E(r),j(!1)};return o.jsxs(Se,{breadcrumbs:oe,children:[o.jsx(xe,{title:t("audios.label.title")}),o.jsxs("div",{className:"flex h-full flex-1 flex-col gap-4 overflow-x-auto rounded-xl p-4",children:[o.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[o.jsxs("div",{children:[o.jsx("h1",{className:"text-2xl font-semibold",children:t("audios.label.title")}),o.jsx("p",{className:"text-sm text-muted-foreground",children:p.title||p.original_filename})]}),o.jsx("div",{className:"flex gap-2",children:o.jsx(B,{asChild:!0,variant:"ghost",children:o.jsxs(ye,{href:"/researcher/audios",children:[o.jsx(Ne,{className:"h-4 w-4 mr-2"}),t("actions.back")]})})})]}),o.jsxs("div",{className:"grid gap-4 lg:grid-cols-3",children:[o.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[o.jsxs("div",{className:"rounded-xl border bg-card p-4 shadow-sm",children:[o.jsxs("div",{className:"flex items-center justify-between mb-3",children:[o.jsx("h2",{className:"text-sm font-semibold",children:t("audios.label.selectLabel")}),o.jsx(Ee,{open:R,onOpenChange:j,onLabelCreated:ve})]}),o.jsx("div",{className:"flex flex-wrap gap-2",children:k.map(r=>o.jsx("button",{type:"button",onClick:()=>E(r),className:`rounded-full px-4 py-2 text-sm font-medium transition-all ${y?.id===r.id?"ring-2 ring-offset-2 scale-105 shadow-lg":"opacity-70 hover:opacity-100"}`,style:{backgroundColor:r.color+"20",border:`2px solid ${r.color}`,color:r.color},title:r.description||void 0,children:o.jsxs("span",{className:"inline-flex items-center gap-2",children:[o.jsx("span",{className:"h-3 w-3 rounded-full",style:{backgroundColor:r.color}}),r.name]})},r.id))})]}),o.jsxs("div",{className:"rounded-xl border bg-card p-4 shadow-sm",children:[o.jsx("div",{className:"flex items-center justify-between mb-3",children:o.jsxs("div",{className:"flex items-center gap-3",children:[o.jsx(B,{variant:"outline",size:"sm",onClick:le,type:"button",className:"flex items-center gap-2",children:a?o.jsxs(o.Fragment,{children:[o.jsx(je,{className:"h-4 w-4"}),t("actions.pause")??"Pause"]}):o.jsxs(o.Fragment,{children:[o.jsx(Pe,{className:"h-4 w-4"}),t("actions.play")??"Play"]})}),o.jsxs("div",{className:"text-sm text-muted-foreground",children:[z(h)," / ",z(l)]})]})}),o.jsxs("div",{className:"relative",children:[o.jsxs("div",{ref:i,className:"w-full bg-gray-100 rounded-lg overflow-hidden relative",style:{height:120},onMouseDown:ue,onMouseMove:pe,onMouseUp:me,children:[o.jsx("div",{ref:s,className:"w-full h-full"}),o.jsxs("div",{className:"absolute inset-0 pointer-events-none z-10",children:[x.map(r=>{const u=ae(r);if(!u.visible)return null;const b=k.find(M=>M.id===r.label_id),w=b?.color||"#3b82f6";return o.jsxs("div",{className:"absolute rounded group pointer-events-auto cursor-pointer hover:shadow-lg transition-all",style:{left:`${u.left}px`,width:`${u.width}px`,top:"10px",height:"100px",backgroundColor:w+"30",border:`2px solid ${w}`,borderRadius:"6px"},onClick:M=>{M.stopPropagation(),ce(r)},children:[o.jsx("div",{className:"absolute left-0 top-0 w-3 h-full bg-gray-900/60 opacity-0 group-hover:opacity-80 cursor-ew-resize rounded-l flex items-center justify-center z-20",onMouseDown:M=>Q(r,"start",M),children:o.jsx("div",{className:"w-0.5 h-8 bg-white rounded"})}),o.jsx("div",{className:"absolute right-0 top-0 w-3 h-full bg-gray-900/60 opacity-0 group-hover:opacity-80 cursor-ew-resize rounded-r flex items-center justify-center z-20",onMouseDown:M=>Q(r,"end",M),children:o.jsx("div",{className:"w-0.5 h-8 bg-white rounded"})}),o.jsx("div",{className:"absolute top-1 left-1 right-7 px-2 py-1 text-xs font-bold text-white bg-black/60 rounded truncate pointer-events-none",children:b?.name??t("audios.label.unknownLabel")??"Label"}),o.jsxs("div",{className:"absolute bottom-1 left-1 px-1 py-0.5 text-xs font-medium text-white bg-black/50 rounded pointer-events-none",children:[(r.end_time-r.start_time).toFixed(1),"s"]}),o.jsx("button",{type:"button",className:"absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600 flex items-center justify-center shadow-lg z-20",onClick:M=>{M.stopPropagation(),K(r.clientId)},children:o.jsx(ee,{className:"h-3 w-3"})})]},r.clientId)}),x.length===0&&o.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:o.jsxs("div",{className:"bg-white/90 px-4 py-2 rounded-lg shadow-sm text-gray-500 text-sm text-center",children:[o.jsx("div",{className:"font-medium mb-1",children:t("audios.label.noSegments")}),o.jsx("div",{className:"text-xs",children:t("audios.label.waveformHelp")||"Drag on the waveform with a label selected to create segments."})]})})]}),D&&o.jsx("div",{className:"absolute bg-amber-500/30 border-2 border-amber-500 pointer-events-none rounded z-20",style:{left:`${Math.min(T,W)}px`,width:`${Math.abs(W-T)}px`,top:"10px",height:"100px"}})]}),o.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:t("audios.label.waveformHelp")||"Tip: Drag on the waveform (with a label selected) to create a segment. Drag the edges to resize, click to play, or use the red icon to delete."})]})]}),o.jsxs("div",{className:"flex gap-2",children:[o.jsxs(B,{onClick:fe,disabled:J,className:"flex-1",type:"button",children:[o.jsx(ke,{className:"h-4 w-4 mr-2"}),J?t("audios.label.saving")??"Saving...":t("audios.label.save")??"Save"]}),x.length>0&&o.jsxs(B,{onClick:ge,variant:"outline",type:"button",children:[o.jsx(De,{className:"h-4 w-4 mr-2"}),t("audios.label.export")??"Export"]})]})]}),o.jsx("div",{className:"space-y-4",children:o.jsxs("div",{className:"rounded-xl border bg-card p-4 shadow-sm",children:[o.jsxs("h2",{className:"text-sm font-semibold mb-3",children:[t("audios.label.segments")," (",x.length,")"]}),x.length===0?o.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:t("audios.label.noSegments")}):o.jsx("div",{className:"space-y-2 max-h-[600px] overflow-y-auto",children:x.map(r=>{const u=k.find(b=>b.id===r.label_id);return o.jsxs("div",{className:"rounded-lg border p-3 space-y-2 hover:bg-muted/50 transition-colors",children:[o.jsxs("div",{className:"flex items-center justify-between",children:[o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx("div",{className:"h-3 w-3 rounded-full",style:{backgroundColor:u?.color}}),o.jsx("span",{className:"text-sm font-medium",children:u?.name??t("audios.label.unknownLabel")??"Label"})]}),o.jsx(B,{size:"sm",variant:"ghost",type:"button",onClick:()=>K(r.clientId),children:o.jsx(ee,{className:"h-3 w-3"})})]}),o.jsxs("div",{className:"text-xs text-muted-foreground",children:[z(r.start_time)," -"," ",z(r.end_time),o.jsxs("span",{className:"ml-2",children:["(",z(r.end_time-r.start_time),")"]})]}),o.jsx(Ce,{value:r.notes||"",onChange:b=>he(r.clientId,b.target.value),placeholder:t("audios.label.notesPlaceholder"),rows:2,className:"text-xs"})]},r.clientId)})})]})})]})]})]})}export{ut as default};
